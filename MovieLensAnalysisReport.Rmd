---
title: "Capstone MovieLens Project Analysis Report"
author: "Khaliun Bat-Ochir"
date: "4/6/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r dataprep-file-source, include=FALSE}
source("MovieLensAnalysisScripts.R", local = knitr::knit_global())
```

# 1. Overview

This is the final Report for Movielens Recommendataion system project for Capstone Course from HarvardX Data Science Professional Certificate program prepared by Khaliun Bat-Ochir.

Final Report includes methodology and results of the project including RMSE calculation. Also, this report includes project environment description used for building and running the code.

## 1.1. Project Goal

This is a Machine Learning project. Goal of the project consists in analysing **MovieLens 10M** and training data with chosen Machine Learning algorithm and reaching RMSE below 0.86490.

## 1.2. Project Data

Project uses **MovieLens 10M** data set. The original code from provided by the instruction for Movielens Recommendation system project for Capstone Course downloads original data and as a [*Zip File*](http://files.grouplens.org/datasets/movielens/ml-10m.zip). Code then processes separate two files named **ratings** and **movies** included in the zip file that are joined together by "movieId" field.

## 1.3. Project Files

Project files will be uploaded for review and grading by peers to Edx course section. Uploaded Files Include:
 
* RMarkdown Report File - "MovieLensAnalysisReport.Rmd"
* R Script File - for convenience, R scripts include
                + MovieLensAnalysisScripts.R - which contains data preparation scripts
                + and MovieLensAnalysisScripts_RMSE_edx_dataset.R" that includes codes for model fitting and RMSE calculation for final model, and sources MovieLensAnalysisScripts.R for running.
* PDF Report - "MovieLensAnalysisReport.pdf"

For convenience purposes, total runing time of each model fitting algorithm had been included in Result section of this report.
 
All the files have been also uploaded to [*MovieLensCodes Github Repository*](https://github.com/khaliunb/MovieLensCodes.git) 

## 1.4. Project Environment

Codes for the project were built and tested using:

* R version 3.6 and
+ RStudio Version 1.3.1073
+ Linux Ubuntu 20.04

# 2. Method

## 2.1. Original Code and Data Set Preparation

Original code divides downloaded data set into following two subsets:

* **edx** - equivalent of **training set** set that contains 80% of the complete MovieLens10K data set
 + **validation** - equivalent of **test set** that contains 20% of the complete MovieLens10K data set

Furthermore, **edx** data set had been matched with **validation** data set and all recurring data had been removed from **validation** data set.

```{r (edx)}
summary(edx)
```

```{r (validation)}
summary(validation)
```

Finally, the code removes temporary data sets (dl, ratings, movies, test_index, temp, movielens, removed) that were used to prepare **edx** and **validation** data sets.

Note: Only **edx** data set have been used for data exploration, model fitting and training the data. **validation** data set will be used for final results and RMSE calculation.

## 2.2. Data Exploration and Sampling method

### 2.2.1. Linear model analysis data

Linear model analysis used for Machine Learning course will be applied for complete **edx** data set and results will be used for final model.

Regularized movie and user effect model have also been attempted on sample of 10'000. However, the results were inconclusive as the sample data did not represent the completed **edx** data set. Therefore final *lambda* value for the model and analysis for the linear model have been carried out using complete **edx** data set. Also **training_set** and **test_set** partitioned from complete **edx** data set had been used. 

### 2.2.2. Random forest analysis data

Total length of the **edx** data set is 9'000'055, which is too large for testing a random forest algorithm. Therefore a separate samples of 10'000, 30'000 and 50'000 have been used for analysis and tests. Resulting sample data frames has been named **movielens10K**, **movielens30K** and **movielens50K** respectively.

#### 2.2.2.1 movielens10k data set

Following is the summary of sample prepared for analysis named **movielens10K**

```{r (movielens10K)}
summary(movielens10K)
```

**movielens10K** data set have been further divided into following subsets:
* **train_set10K** - 80% of the **movielens10K** data set
 + **train_set10K** - 20% of the **movielens10K** data set
for fitting model and training.

Next, **train_set10K** data set had been matched with **test_set10K** data set and all recurring data had been removed from **test_set10K** data set.

```{r (train_set10K)}
summary(train_set10K)
```

```{r (test_set10K)}
summary(test_set10K)
```

#### 2.2.2.2 movielens30k data set

Following is the summary of sample prepared for analysis named **movielens30K**

```{r (movielens30K)}
summary(movielens30K)
```

**movielens30K** data set have been further divided into following subsets:
* **train_set30K** - 80% of the **movielens30K** data set
 + **train_set30K** - 20% of the **movielens30K** data set
for fitting model and training.

Next, **train_set30K** data set had been matched with **test_set30K** data set and all recurring data had been removed from **test_set30K** data set.

```{r (train_set30K)}
summary(train_set30K)
```

```{r (test_set30K)}
summary(test_set30K)
```

#### 2.2.2.3 movielens50k data set

Following is the summary of sample prepared for analysis named **movielens50K**

```{r (movielens50K)}
summary(movielens50K)
```

**movielens50K** data set have been further divided into following subsets:
* **train_set50K** - 80% of the **movielens50K** data set
 + **train_set50K** - 20% of the **movielens50K** data set
for fitting model and training.

Next, **train_set50K** data set had been matched with **test_set50K** data set and all recurring data had been removed from **test_set50K** data set.

```{r (train_set50K)}
summary(train_set50K)
```

```{r (test_set50K)}
summary(test_set50K)
```

## 2.3. Failures and Insights gained

Kmeans clustering have been tried for grouping movies into relevant groups as an attempt to replicate PCA analysis and incorporated the group ids to **edx** data set. However, the final RMSE for movie group model is 0.99 and does not go down for any values of k. Therefore the approach have been dropped. Code performing this analysis have been commented out in file * MovieAnalysisScripts_RMSE_edx_dataset.R *

## 2.4. Model fitting and RMSE approach: Ensemble

Regularized movie and user effect model have be used for final model. To improve RMSE further, random forest and knn algorithms will be tuned for respective parameters. Final model predictions from lm(), randomForest() algorithms have been averaged, thus creating an ensemble.

Models have been tested out on samples of data and RMSE will be calculated for each version prior to training final model.

# 3. Result

Note: Results section contains plots and summary results present in code file * MovieAnalysisScripts_RMSE_edx_dataset.R.* You can find relevant comments as a description for each result in this file.

## 3.1. Linear model performance

We are showing distinct userId and distinct movieIds in movielens data to get the idea.

```{r edx-user-movies-number}
edx %>%
  summarize(n_users = n_distinct(userId),
            n_movies = n_distinct(movieId))
```

```{r keep-prep-script, include=FALSE}
keep <- edx %>%
  dplyr::count(movieId) %>%
  top_n(5) %>%
  pull(movieId)
```

Now, let us list top 5 most rated movies in movielens data
```{r (keep)}
keep
```

```{r tab-prep-script, include=FALSE}
keep_raters<-edx %>% filter(movieId %in% keep) %>%
    mutate(rating=1) %>%
    select(movieId,userId,rating) %>%
    group_by(userId) %>%
    summarize(n=sum(rating)) %>%
    head()%>%
    pull(userId)

tab <- edx %>%
  filter(userId %in% keep_raters) %>% 
  filter(movieId %in% keep) %>%
  arrange(userId) %>%
  select(userId, title, rating) %>% 
  spread(title, rating)
```

Following code shows top 5 most rated movies' ratings in movielens data and transposes the title and rating columns by value and lists the results for userId column.
        
```{r (tab)}
tab %>% knitr::kable()
```

```{r ratings-spread-plot, echo=FALSE}
users <- sample(unique(edx$userId), 100)

rafalib::mypar()
edx %>% filter(userId %in% users) %>% 
  select(userId, movieId, rating) %>%
  mutate(rating = 1) %>%
  spread(movieId, rating) %>% select(sample(ncol(.), 100)) %>% 
  as.matrix() %>% t(.) %>%
  image(1:100, 1:100,. , xlab="Movies", ylab="Users") 

abline(h=0:100+0.5, v=0:100+0.5, col = "grey")
```

Plot counts number of times each movieId is rated and creates geom_histogram which scales the number of movies by log10

```{r movies-plot, echo=FALSE}
edx %>% 
  dplyr::count(movieId) %>% 
  ggplot(aes(n)) + 
  geom_histogram(bins = 30, color = "black") + 
  scale_x_log10() + 
  ggtitle("Movies")
```

Plot counts number of times each userId is rated and creates geom_histogram which scales the number of users who had given ratings by log10

```{r users-plot, echo=FALSE}
edx %>%
  dplyr::count(userId) %>% 
  ggplot(aes(n)) + 
  geom_histogram(bins = 30, color = "black") + 
  scale_x_log10() +
  ggtitle("Users")
```  

### 3.1.1. lambda value

```{r linear-model-rmse, include=FALSE}
lambdas <- seq(0, 10, 0.25)
RMSE <- function(true_ratings, predicted_ratings){
  sqrt(mean((true_ratings - predicted_ratings)^2))
}
mu <- mean(train_set$rating)
rmses <- sapply(lambdas, function(l){
  b_i <- train_set %>%
    group_by(movieId) %>%
    summarize(b_i = sum(rating - mu)/(n()+l))
  b_u <- train_set %>% 
    left_join(b_i, by="movieId") %>%
    group_by(userId) %>%
    summarize(b_u = sum(rating - b_i - mu)/(n()+l))
  predicted_ratings <- 
    test_set %>% 
    left_join(b_i, by = "movieId") %>%
    left_join(b_u, by = "userId") %>%
    mutate(pred = mu + b_i + b_u) %>%
    .$pred
  return(RMSE(predicted_ratings, test_set$rating))
})

lambda <- lambdas[which.min(rmses)]
rmse_results <-data_frame(method="Regularized Movie + User Effect Model",
                                     RMSE = min(rmses))
```

```{r lambda-qplot, echo=FALSE}
qplot(lambdas, rmses)
```

Analysis results for the Regularized Movie + User Effect model shows that the optimal value of lambda is as follows:

```{r lambda-optimal-value, echo=FALSE}
lambda
```
This value we will incorporate in the actual training of the linear model.

### 3.1.2. Regularized Movie + User Effect model RMSE

Final minimum RMSE for Regularized Movie + User Effect is as follows:

```{r, echo=FALSE}
rmse_results %>% knitr::kable()
```

## 3.3. Random Forest model performance

### 3.3.1. Parameter tuning Results using sampling

### 3.3.2. Growing the tree

### 3.3.3. Random Forest algorithm RMSE on the actual dataset

## 3.4. Ensemble and Final RMSE

### 3.4.1. Sample ensemble RMSE result

### 3.4.2. Results of training of **edx** set and **validation** set

Training of complete **edx** set was performed. Total time of execution took * 1 hour *.

# 4. Conclusion

For final result, ensemble of Regularized movie and user effect model, random forest results have been used. Final RMSE is below 0.86490.
